@model KitsRequestsViewModel

@{
    ViewData["Title"] = "Kit Requests";
    var isReadonly = Model.ExistingRequest != null;
}

<h2 class="text-left">@ViewData["Title"]</h2>

<div class="container">
@if (isReadonly)
{
    <div class="mb-3">
        <a href="@Url.Action("Index", "EquipmentKitManager")" class="btn btn-secondary btn-sm">
            ← Back to Equipment & Kit Manager
        </a>
    </div>
}

<div class="row">
    <div class="col-12">

        @if (isReadonly)
        {
            <div class="alert alert-warning" role="alert">
                🛑 This kit request has already been submitted and cannot be edited.
            </div>
        }
        else
        {
            <p class="text-left">
                Please use the below form to submit your kit request for the committee to review.
            </p>
            <p class="text-left">
                Please ensure you know all the information required for a complete order before completing this form to ensure there are no delays.
            </p>
            <p class="text-left">
                The team name will be based on your season 2025-2026 age level.
            </p>
            <p class="text-left">
                If the player requires a quarter zip top including as part of the kit request this will be based on the size of the selected shirt size.
            </p>
        }
    </div>
</div>

<!-- Accordion (Mobile Only) -->
<div class="accordion d-md-none mb-4" id="kitGalleryAccordion">
    <div class="accordion-item bg-accordion">
        <h2 class="accordion-header" id="headingKitsMobile">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapseKitsMobile"
                    aria-expanded="false" aria-controls="collapseKitsMobile">
                2025/2026 Kits
            </button>
        </h2>
        <div id="collapseKitsMobile" class="accordion-collapse collapse"
             aria-labelledby="headingKitsMobile" data-bs-parent="#kitGalleryAccordion">
            <div class="accordion-body bg-white text-dark">
                @Html.Partial("_KitGalleryContent")
            </div>
        </div>
    </div>
</div>

<!-- Desktop view (Always visible) -->
<div class="d-none d-md-block">
    <div class="row mt-4">
        <div class="col-12">
            <h4 class="mb-3">2025/2026 Kits</h4>
            <p class="mb-4">
                We're excited to reveal our brand new kits for the 2025/26 season! Below you can preview the full range, including home, away, and goalkeeper kits.
            </p>
            @Html.Partial("_KitGalleryContent")
        </div>
    </div>
</div>

<!-- 🔥 Modal rendered ONCE globally (works for all screen sizes) -->
<div class="modal fade" id="kitModal" tabindex="-1" aria-labelledby="kitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="kitModalLabel">Kit Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="kitModalImage" src="" alt="Kit Full View" style="max-width: 100%; height: auto;">
            </div>
        </div>
    </div>
</div>




<form id="teamForm" class="mt-3" enctype="multipart/form-data">
<!-- Team dropdown -->
<div class="row mb-3">
    <div class="col-md-6">
        <label class="form-label">Select Team</label>
        <select id="teamSelect" class="form-select" required @(isReadonly ? "disabled" : "")>
            <option value="" disabled selected>Select Team</option>
            @{
                foreach (var team in Model.Teams.DistinctBy(t => t.Name))
                {
                    var selected = Model.ExistingRequest?.TeamName == team.Name ? "selected=\"selected\"" : "";
                    @:<option value="@team.Name" @Html.Raw(selected)>@team.Name</option>
                }
            }
        </select>
        <div class="invalid-feedback">Please select a team.</div>
    </div>
</div>

<!-- Manager Details -->
<div class="row mb-3">
    <div class="col-md-4">
        <div class="form-floating">
            <input type="text" id="managerName" name="ManagerName" class="form-control" required
                   value="@(Model.ExistingRequest?.ManagerName ?? "")" @(isReadonly ? "readonly" : "")/>
            <label>Manager Name</label>
            <div class="invalid-feedback">Please enter the manager's name.</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-floating">
            <input type="text" id="managerMobile" name="ManagerMobile" class="form-control" required
                   inputmode="numeric" pattern="[0-9]{11}" minlength="11" maxlength="11"
                   value="@(Model.ExistingRequest?.ManagerMobile ?? "")" @(isReadonly ? "readonly" : "") />
            <label>Manager Mobile No.</label>
            <div class="invalid-feedback">Please enter an 11-digit mobile number (numbers only).</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-floating">
            <input type="email" id="managerEmail" name="ManagerEmail" class="form-control" required
                   value="@(Model.ExistingRequest?.ManagerEmail ?? "")" @(isReadonly ? "readonly" : "")/>
            <label>Manager Email</label>
            <div class="invalid-feedback">Please enter a valid email address.</div>
        </div>
    </div>
</div>

<!-- Additional Information -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="form-floating">
            <textarea id="additionalInfo" name="AdditionalInfo" class="form-control" style="height: 100px;" @(isReadonly ? "readonly" : "")>@(Model.ExistingRequest?.AdditionalInfo ?? "")</textarea>
            <label>Additional Information About Request</label>
        </div>
    </div>
</div>

<!-- Sponsor Logo Upload -->
<div class="row mb-3">
    <div class="col-md-6">
        <label class="form-label">Sponsor Logo (optional)</label>

        @if (isReadonly && Model.ExistingRequest?.SponsorLogo != null && Model.ExistingRequest?.SponsorLogo.Length > 0)
        {
            var base64Logo = Convert.ToBase64String(Model.ExistingRequest?.SponsorLogo);
            var imageSrc = $"data:image/png;base64,{base64Logo}";
            <div class="mt-2">
                <img src="@imageSrc" alt="Sponsor Logo" class="img-fluid border rounded mb-2" style="max-height: 200px;"/>
            </div>
        }
        else
        {
            <input type="file" id="sponsorLogo" name="SponsorLogo" class="form-control" accept="image/*" onchange="previewSponsorLogo()" @(isReadonly ? "disabled" : "")/>

            <div id="sponsorLogoPreviewContainer" class="mt-3" style="display:none;">
                <label class="form-label">Logo Preview:</label>
                <img id="sponsorLogoPreview" src="#" alt="Logo Preview" class="img-fluid border rounded mb-2" style="max-height: 200px;"/>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="replaceSponsorLogo()">Replace Logo</button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeSponsorLogo()">Remove Logo</button>
                </div>
            </div>
        }
    </div>
</div>


<!-- Kit Items -->
<div id="itemRows">
    <label class="form-label">Player Kits</label><br/>
    @if (isReadonly)
    {
        @foreach (var player in Model.ExistingRequest.Players)
        {
            <label class="form-label">Player #@player.ShirtNumber</label>
            <div class="row g-2 mb-3 team-item">
                <div class="col-12 col-md-2">
                    <div class="form-floating">
                        <input type="text" class="form-control" value="@player.TopSize" disabled />
                        <label>Top Size</label>
                    </div>
                </div>

                <div class="col-12 col-md-2">
                    <div class="form-floating">
                        <input type="text" class="form-control" value="@player.ShortsSize" disabled />
                        <label>Shorts Size</label>
                    </div>
                </div>

                <div class="col-12 col-md-2">
                    <div class="form-floating">
                        <input type="text" class="form-control" value="@player.SocksSize" disabled />
                        <label>Socks Size</label>
                    </div>
                </div>

                <div class="col-12 col-md-2">
                    <div class="form-floating">
                        <input type="number" class="form-control" value="@player.ShirtNumber" readonly />
                        <label>Shirt Number</label>
                    </div>
                </div>

                <div class="col-12 col-md-2">
                    <div class="form-floating">
                        <input type="text" class="form-control" value="@player.KitType" disabled />
                        <label>Kit</label>
                    </div>
                </div>

                <div class="col-12 col-md-2">
                    <div class="form-floating">
                        <input type="text" class="form-control" value="@player.QuarterZip" disabled />
                        <label>Quarter Zip</label>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="row g-2 mb-3 team-item">
            <div class="col-12 col-md-2">
                <div class="form-floating">
                    <select name="TopSize" class="form-select" required>
                        <option value="" disabled selected>Select</option>
                        <option value="XSJ">XSJ - Youth</option>
                        <option value="SJ">SJ - Youth</option>
                        <option value="MJ">MJ - Youth</option>
                        <option value="LY">LY - Youth</option>
                        <option value="XLY">XLY - Youth</option>
                        <option value="XS">XS - Adult</option>
                        <option value="S">S - Adult</option>
                        <option value="M">M - Adult</option>
                        <option value="L">L - Adult</option>
                        <option value="XL">XL - Adult</option>
                    </select>
                    <label>Top Size</label>
                    <div class="invalid-feedback">Please select a top size.</div>
                </div>
            </div>

            <div class="col-12 col-md-2">
                <div class="form-floating">
                    <select name="ShortsSize" class="form-select" required>
                        <option value="" disabled selected>Select</option>
                        <option value="XSY">XSY - Youth</option>
                        <option value="SY">SY - Youth</option>
                        <option value="MY">MY - Youth</option>
                        <option value="LY">LY - Youth</option>
                        <option value="XLY">XLY - Youth</option>
                        <option value="XS">XS - Adult</option>
                        <option value="S">S - Adult</option>
                        <option value="M">M - Adult</option>
                        <option value="L">L - Adult</option>
                        <option value="XL">XL - Adult</option>
                    </select>
                    <label>Shorts Size</label>
                    <div class="invalid-feedback">Please select a shorts size.</div>
                </div>
            </div>

            <div class="col-12 col-md-2">
                <div class="form-floating">
                    <select name="SocksSize" class="form-select" required>
                        <option value="" disabled selected>Select</option>
                        <option value="UK C12 - 2">UK C12 - 2</option>
                        <option value="UK 3 - 6">UK 3 - 6</option>
                        <option value="UK 7 - 11">UK 7 - 11</option>
                    </select>
                    <label>Socks Size</label>
                    <div class="invalid-feedback">Please select a socks size.</div>
                </div>
            </div>

            <div class="col-12 custom-col-md-12-5">



                <div class="form-floating">
                    <input type="number" name="ShirtNumber" class="form-control" min="1" inputmode="numeric" pattern="[0-9]*" required/>
                    <label>Shirt Number</label>
                    <div class="invalid-feedback">Please enter a shirt number (minimum 1).</div>
                </div>
            </div>

            <div class="col-12 col-md-2">
                <div class="form-floating">
                    <select name="KitType" class="form-select" required>
                        <option value="" disabled selected>Select</option>
                        <option value="Home">Home</option>
                        <option value="Away - Existing">Away - Existing Design</option>
                        <option value="Away - New">Away - New Design</option>
                        <option value="Keeper - Green">Keeper - Green</option>
                        <option value="Keeper - Red">Keeper - Red</option>
                        <option value="Keeper - Pink">Keeper - Pink</option>
                    </select>
                    <label>Kit</label>
                    <div class="invalid-feedback">Please select a kit type.</div>
                </div>
            </div>
            <div class="col-12 custom-col-md-12-5">
                <div class="form-floating">
                    <select name="QuarterZip" class="form-select" required>
                        <option value="No" selected>No</option>
                        <option value="Yes">Yes</option>
                    </select>
                    <label>Quarter Zip</label>
                    <div class="invalid-feedback">Please select if quarter zip required.</div>
                </div>
            </div>

            <div class="col-12 col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-danger w-100 h-100" onclick="removeRow(this)">Remove</button>
            </div>
        </div>
    }
</div>


@if (!isReadonly)
{
    <div class="row mt-3">
        <div class="col-md-3">
            <button type="button" class="btn btn-secondary w-100" onclick="addRow()">Add Another Kit</button>
        </div>
        <div class="col-md-3">
            <button type="button" class="btn btn-primary w-100" onclick="submitRequest()">Submit Team Request</button>
        </div>
    </div>
}
else
{
    <div class="row mt-3">
        <div class="col-md-3">
            <a class="btn btn-success w-100" href="@Url.Action("DownloadKitRequestExcel", "KitRequests", new { id = Model.ExistingRequest.Id })">
                Download as Excel
            </a>
        </div>
        <div class="col-md-3">
            <a class="btn btn-danger w-100" href="@Url.Action("DownloadSponsorLogoPdf", "KitRequests", new { id = Model.ExistingRequest.Id })">
                Download Sponsor PDF
            </a>
        </div>
        <div class="col-md-3">
            <a class="btn btn-primary w-100" href="@Url.Action("DownloadInvoiceDocument", "KitRequests", new { id = Model.ExistingRequest.Id })">
                Download Sample Invoice Document
            </a>
        </div>
    </div>
}
</form>
</div>

<!-- Modal for Form Messages -->
<div class="modal fade" id="formMessageModal" tabindex="-1" aria-labelledby="formMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formMessageModalLabel">Kit Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="formMessageModalBody">
                <!-- Dynamic message will be injected here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script src="~/js/kitrequests.js"></script>